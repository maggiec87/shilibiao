<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>基准测试</title>
<style>
  body { font-family: sans-serif; background: #f0f0f0; margin:0; padding:0; overflow: hidden; }
  .test-header { display:flex; justify-content: space-between; padding: 15px 20px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .test-title { font-size: 1.1em; font-weight: bold; }
  .test-info { display:flex; gap: 15px; font-variant-numeric: tabular-nums; }
  .test-main { display:flex; justify-content:center; align-items:center; height: calc(100vh - 60px); position: relative; }
  
  #e-chart-container { 
    width: 200px; 
    height: 200px; 
    display:flex; 
    justify-content:center; 
    align-items:center; 
    position: relative;
  }

  #e-chart-svg { width: 100%; height: 100%; }

  /* 错误反馈样式 - 同雾视挑战 */
  #error-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 150px;
    color: rgba(255, 0, 0, 0.8);
    display: none;
    pointer-events: none;
    z-index: 100;
    font-weight: bold;
    text-shadow: 0 0 10px white;
  }

  .wait-hint { position: absolute; bottom: 20px; color: #666; font-size: 0.9em; display: none; }
</style>
</head>

<body>

<div id="page-test">
  <header class="test-header">
    <div id="test-title" class="test-title"></div>
    <div class="test-info">
      <div><span>得分:</span> <span id="test-score">0/0</span></div>
    </div>
  </header>

  <main class="test-main">
    <div id="e-chart-container">
      <div id="error-overlay">✕</div>
      <svg id="e-chart-svg" viewBox="0 0 5 5">
        <path d="M0,0 H5 V1 H1 V2 H5 V3 H1 V4 H5 V5 H0 Z" fill="currentColor"/>
      </svg>
    </div>
    <div id="next-hint" class="wait-hint">请按任意键继续...</div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

const DIRECTIONS = ['up','down','left','right'];
const KEY_MAP = {ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right'};
const ROTATION_MAP = {up:-90,down:90,left:180,right:0};

let testConfig = null;
let audioCtx = null;
let state = {
  status:'idle',
  correct:0,
  total:0,
  currentE:null,
  waitingForConfirm: false
};

const eChart = document.getElementById('e-chart-svg');
const scoreEl = document.getElementById('test-score');
const errorOverlay = document.getElementById('error-overlay');
const nextHint = document.getElementById('next-hint');

// 初始化音频
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

// 播放错误声效
function playErrorSound() {
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sawtooth'; 
    osc.frequency.setValueAtTime(120, audioCtx.currentTime); 
    osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.2);
}

function renderE(sizePx, dir){
  eChart.style.width = sizePx + 'px';
  eChart.style.height = sizePx + 'px';
  eChart.style.transform = `rotate(${ROTATION_MAP[dir]}deg)`;
}

function generateRandomE(level){
  return { level, direction:DIRECTIONS[Math.floor(Math.random()*4)] };
}

function startTest(config){
  testConfig = config;
  state = {
    status:'running',
    correct:0,
    total:0,
    currentE:generateRandomE(config.level),
    waitingForConfirm: false
  };
  document.getElementById('test-title').textContent = `基准测试 - ${config.level.decimal}`;
  updateUI();
}

function handleInput(key) {
  if (state.status !== 'running') return;

  // 如果正在等待确认（错误状态下），按任意键继续
  if (state.waitingForConfirm) {
    proceedToNext();
    return;
  }

  const dir = KEY_MAP[key];
  if (!dir) return;

  const isCorrect = (dir === state.currentE.direction);
  
  if (isCorrect) {
    state.correct++;
    state.total++;
    // 正确则直接进入下一题判断
    checkProgress();
  } else {
    state.total++;
    // 错误则进入停顿反馈状态
    showErrorState();
  }
}

function showErrorState() {
  state.waitingForConfirm = true;
  errorOverlay.style.display = 'block';
  nextHint.style.display = 'block';
  playErrorSound();
  updateUI();
}

function proceedToNext() {
  state.waitingForConfirm = false;
  errorOverlay.style.display = 'none';
  nextHint.style.display = 'none';
  checkProgress();
}

function checkProgress() {
  // 10 题结束
  if (state.total >= 10) {
    finishTest();
  } else {
    state.currentE = generateRandomE(testConfig.level);
    updateUI();
  }
}

function updateUI(){
  scoreEl.textContent = `${state.correct}/${state.total}`;
  renderE(state.currentE.level.sizePx, state.currentE.direction);
}

function finishTest(){
  state.status='finished';
  saveRecord();
  window.location.href='history.html';
}

function saveRecord(){
  try {
    let history = JSON.parse(localStorage.getItem('visionHistory')||'[]');
    const now = new Date();
    // 严格遵循 yyyy-mm-dd 格式
    const formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const formattedTime = now.toTimeString().split(' ')[0];

    const newRecord = {
      date: formattedDate,
      time: formattedTime,
      testType: 'base',
      levelInfo: {
        minLevels: [testConfig.level.decimal] // 保持与 fog 模式结构类似，方便历史页展示
      },
      level: testConfig.level.decimal,
      score: `${state.correct}/${state.total}`,
      accuracy: (state.correct / state.total * 100).toFixed(1) + '%'
    };

    history.unshift(newRecord);
    localStorage.setItem('visionHistory', JSON.stringify(history));
  } catch (e) {
    console.error("保存失败", e);
  }
}

window.addEventListener('keydown',(e)=>{
  if (e.repeat) return; // 屏蔽长按连发
  initAudio(); // 交互后激活音频上下文
  handleInput(e.key);
});

const stored = localStorage.getItem('testConfig');
if(!stored){ 
  window.location.href='index.html'; 
  return;
}
startTest(JSON.parse(stored));

});
</script>

</body>
</html>